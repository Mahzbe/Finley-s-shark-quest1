<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finley's Shark Quest</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        canvas {
            border: 1px solid #000;
        }
        #start-menu, #game-over-screen {
            text-align: center;
            margin-top: 20px;
        }
        #puzzle-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-gap: 2px;
            margin: 20px auto;
            width: 400px;
        }
        .block {
            width: 100%;
            padding-top: 100%;
            position: relative;
            cursor: pointer;
        }
        .block div {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #finley, #shark {
            position: absolute;
            width: 50px;
            height: 50px;
        }
        #finley {
            background-color: green;
        }
        #shark {
            background-color: red;
        }
    </style>
</head>
<body>
    <canvas id="game-canvas" width="800" height="600" style="display: none;"></canvas>
    <div id="start-menu" style="display: block;">
        <h1>Finley's Shark Quest</h1>
        <button id="start-button" onclick="startGame()">Start Game</button>
    </div>
    <div id="game-over-screen" style="display: none;">
        <h1>Game Over!</h1>
        <p>Your score: <span id="final-score"></span></p>
        <button id="restart-button" onclick="restartGame()">Restart</button>
    </div>
    <div id="puzzle-grid"></div>
    <div id="finley"></div>
    <div id="shark"></div>
    <p>Moves left: <span id="moves-count">7</span></p>
    <script>
        let game = {
            level: 0,
            puzzle: {
                puzzlePieces: [],
                sharkBehavior: {
                    speed: 1,
                    aggression: 1
                }
            },
            shark: {
                speed: 1,
                aggression: 1,
                x: 700, // Initial position
                y: 100,
                width: 50,
                height: 50
            },
            finley: {
                x: 50, // Initial position
                y: 50,
                width: 50,
                height: 50
            },
            score: 0,
            movesLeft: 7,
            puzzleGrid: Array.from({ length: 4 }, () => Array(4).fill(null)),
            puzzleSolved: false
        };

        const colors = ['red', 'blue', 'green', 'yellow'];
        let selectedPiece = null;

        function startGame() {
            document.getElementById("start-menu").style.display = "none";
            document.getElementById("game-canvas").style.display = "block";
            document.getElementById('finley').style.left = game.finley.x + 'px';
            document.getElementById('finley').style.top = game.finley.y + 'px';
            document.getElementById('shark').style.left = game.shark.x + 'px';
            document.getElementById('shark').style.top = game.shark.y + 'px';
            generatePuzzle();
            renderPuzzleGrid();
            gameLoop();
        }

        function generatePuzzle() {
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    game.puzzleGrid[i][j] = colors[Math.floor(Math.random() * colors.length)];
                }
            }
            renderPuzzleGrid();
        }

        function renderPuzzleGrid() {
            const puzzleGridElement = document.getElementById('puzzle-grid');
            puzzleGridElement.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    const block = document.createElement('div');
                    block.classList.add('block');
                    block.style.backgroundColor = game.puzzleGrid[i][j];
                    block.dataset.row = i;
                    block.dataset.col = j;
                    puzzleGridElement.appendChild(block);
                }
            }
        }

        function handleBlockClick(event) {
            if (event.target.classList.contains('block')) {
                const row = event.target.dataset.row;
                const col = event.target.dataset.col;

                if (selectedPiece) {
                    const tempColor = game.puzzleGrid[selectedPiece.dataset.row][selectedPiece.dataset.col];
                    game.puzzleGrid[selectedPiece.dataset.row][selectedPiece.dataset.col] = game.puzzleGrid[row][col];
                    game.puzzleGrid[row][col] = tempColor;
                    renderPuzzleGrid();
                    checkMatches();
                    game.movesLeft--;
                    document.getElementById('moves-count').innerText = game.movesLeft;
                    selectedPiece.classList.remove('selected');
                    selectedPiece = null;

                    if (game.movesLeft <= 0 && !game.puzzleSolved) {
                        gameOver();
                    }
                } else {
                    event.target.classList.add('selected');
                    selectedPiece = event.target;
                }
            }
        }

        function checkMatches() {
            let matches = 0;

            const checkDirection = (row, col, dr, dc) => {
                const color = game.puzzleGrid[row][col];
                let count = 1;
                while (true) {
                    row += dr;
                    col += dc;
                    if (row < 0 || row >= 4 || col < 0 || col >= 4 || game.puzzleGrid[row][col] !== color) break;
                    count++;
                }
                return count >= 3 ? count : 0;
            };

            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    if (game.puzzleGrid[i][j]) {
                        let count = checkDirection(i, j, 0, 1) || checkDirection(i, j, 1, 0);
                        if (count) {
                            matches++;
                            for (let k = 0; k < count; k++) {
                                game.puzzleGrid[i + k * (checkDirection(i, j, 1, 0) ? 1 : 0)][j + k * (checkDirection(i, j, 0, 1) ? 1 : 0)] = null;
                            }
                        }
                    }
                }
            }

            if (matches >= 5) {
                game.puzzleSolved = true;
                alert('You won!');
                document.getElementById('game-over-screen').style.display = 'block';
                document.getElementById('final-score').innerText = game.score;
            } else if (game.movesLeft <= 0 && !game.puzzleSolved) {
                gameOver();
            } else {
                refillPuzzleGrid();
            }
        }

        function refillPuzzleGrid() {
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    if (!game.puzzleGrid[i][j]) {
                        game.puzzleGrid[i][j] = colors[Math.floor(Math.random() * colors.length)];
                    }
                }
            }
            renderPuzzleGrid();
        }

        function updateSharkPosition() {
            const dx = game.finley.x - game.shark.x;
            const dy = game.finley.y - game.shark.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > 0) {
                const moveX = (dx / distance) * game.shark.speed;
                const moveY = (dy / distance) * game.shark.speed;
                game.shark.x += moveX;
                game.shark.y += moveY;
                document.getElementById('shark').style.left = game.shark.x + 'px';
                document.getElementById('shark').style.top = game.shark.y + 'px';
            }
        }

        function updateFinleyPosition() {
            document.getElementById('finley').style.left = game.finley.x + 'px';
            document.getElementById('finley').style.top = game.finley.y + 'px';
        }

        function checkCollisions() {
            if (checkCollision(game.finley, game.shark)) {
                if (!game.puzzleSolved) {
                    gameOver();
                }
            }
        }

        function checkCollision(object1, object2) {
            return object1.x < object2.x + object2.width &&
                   object1.x + object1.width > object2.x &&
                   object1.y < object2.y + object2.height &&
                   object1.y + object1.height > object2.y;
        }

        function updateGame() {
            updateSharkPosition();
            checkCollisions();
            updateFinleyPosition();
        }

        function render() {
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = '24px Arial';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(`Score: ${game.score}`, 10, 10);
        }

        function gameLoop() {
            if (!game.puzzleSolved) {
                updateGame();
                render();
                requestAnimationFrame(gameLoop);
            }
        }

        function gameOver() {
            document.getElementById("game-over-screen").style.display = "block";
            document.getElementById("final-score").innerText = game.score;
        }

        function restartGame() {
            game.score = 0;
            game.level = 0;
            game.puzzle.puzzlePieces = [];
            game.shark.speed = 1;
            game.shark.aggression = 1;
            game.finley.x = 50;
            game.finley.y = 50;
            game.shark.x = 700;
            game.shark.y = 100;
            game.movesLeft = 7;
            game.puzzleSolved = false;
            document.getElementById("game-over-screen").style.display = "none";
            startGame();
        }

        document.getElementById('puzzle-grid').addEventListener('click', handleBlockClick);
    </script>
</body>
</html>
