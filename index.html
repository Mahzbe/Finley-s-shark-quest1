<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finley's Shark Quest</title>
    <style>
        #game-canvas {
            border: 1px solid black;
        }
        #puzzle-container {
            display: flex;
            flex-wrap: wrap;
            width: 400px;
        }
        .puzzle-block {
            width: 100px;
            height: 100px;
            display: inline-block;
            box-sizing: border-box;
            border: 1px solid black;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <canvas id="game-canvas" width="800" height="600"></canvas>
    <div id="start-menu" style="display: block;">
        <h1>Finley's Shark Quest</h1>
        <button id="start-button" onclick="startGame()">Start Game</button>
    </div>
    <div id="game-over-screen" style="display: none;">
        <h1>Game Over!</h1>
        <p>Your score: <span id="final-score"></span></p>
        <button id="restart-button" onclick="restartGame()">Restart</button>
    </div>
    <div id="puzzle-container"></div>
    <div>Moves Remaining: <span id="moves-count">7</span></div>
    <script>
        let game = {
            level: 0,
            puzzle: {
                puzzlePieces: [],
                puzzleGrid: [],
                matches: 0
            },
            shark: {
                speed: 1,
                x: 100,
                y: 100
            },
            finley: {
                x: 400,
                y: 300,
                width: 50,
                height: 50
            },
            score: 0,
            movesRemaining: 7,
            gameOver: false
        };

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const puzzleContainer = document.getElementById('puzzle-container');

        function startGame() {
            document.getElementById("start-menu").style.display = "none";
            document.getElementById("game-canvas").style.display = "block";
            document.getElementById("puzzle-container").style.display = "block";
            document.getElementById("game-over-screen").style.display = "none";
            game.gameOver = false;
            game.puzzle.matches = 0;
            game.movesRemaining = 7;
            document.getElementById('moves-count').innerText = game.movesRemaining;
            generatePuzzle();
            gameLoop();
        }

        function generatePuzzle() {
            game.puzzle.puzzleGrid = [];
            for (let i = 0; i < 4; i++) {
                game.puzzle.puzzleGrid[i] = [];
                for (let j = 0; j < 4; j++) {
                    game.puzzle.puzzleGrid[i][j] = Math.floor(Math.random() * 4) + 1;
                }
            }
            renderPuzzle();
        }

        function renderPuzzle() {
            puzzleContainer.innerHTML = '';
            game.puzzle.puzzleGrid.forEach((row, i) => {
                row.forEach((block, j) => {
                    const div = document.createElement('div');
                    div.classList.add('puzzle-block');
                    div.style.backgroundColor = getColor(block);
                    div.dataset.row = i;
                    div.dataset.col = j;
                    div.addEventListener('click', () => handleBlockClick(i, j));
                    puzzleContainer.appendChild(div);
                });
            });
        }

        function getColor(value) {
            switch (value) {
                case 1: return 'red';
                case 2: return 'green';
                case 3: return 'blue';
                case 4: return 'yellow';
            }
        }

        function handleBlockClick(row, col) {
            if (game.movesRemaining <= 0 || game.gameOver) return;

            game.movesRemaining--;
            document.getElementById('moves-count').innerText = game.movesRemaining;

            // Match logic
            checkForMatches();

            if (game.movesRemaining <= 0 && game.puzzle.matches < 5) {
                endGame('lose');
            }
        }

        function checkForMatches() {
            let matchesFound = false;

            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    if (game.puzzle.puzzleGrid[i][j] !== null) {
                        const color = game.puzzle.puzzleGrid[i][j];
                        if (checkMatch(i, j, color)) {
                            matchesFound = true;
                            game.puzzle.puzzleGrid[i][j] = null;
                            removeMatches();
                        }
                    }
                }
            }

            if (matchesFound) {
                game.puzzle.matches++;
                if (game.puzzle.matches >= 5) {
                    endGame('win');
                }
            }
            renderPuzzle();
        }

        function checkMatch(row, col, color) {
            return (checkLine(row, col, color, 1, 0) >= 3 || // Horizontal
                    checkLine(row, col, color, 0, 1) >= 3); // Vertical
        }

        function checkLine(row, col, color, rowStep, colStep) {
            let count = 0;
            while (row >= 0 && col >= 0 && row < 4 && col < 4 && game.puzzle.puzzleGrid[row][col] === color) {
                count++;
                row += rowStep;
                col += colStep;
            }
            return count;
        }

        function removeMatches() {
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    if (game.puzzle.puzzleGrid[i][j] === null) {
                        for (let k = i; k > 0; k--) {
                            game.puzzle.puzzleGrid[k][j] = game.puzzle.puzzleGrid[k - 1][j];
                        }
                        game.puzzle.puzzleGrid[0][j] = Math.floor(Math.random() * 4) + 1;
                    }
                }
            }
        }

        function endGame(result) {
            game.gameOver = true;
            document.getElementById("game-canvas").style.display = "none";
            document.getElementById("puzzle-container").style.display = "none";
            document.getElementById("game-over-screen").style.display = "block";
            if (result === 'win') {
                document.getElementById("final-score").innerText = "You Win!";
            } else {
                document.getElementById("final-score").innerText = "Game Over!";
            }
        }

        function restartGame() {
            game.score = 0;
            game.puzzle.matches = 0;
            game.movesRemaining = 7;
            generatePuzzle();
            document.getElementById("game-over-screen").style.display = "none";
            document.getElementById("game-canvas").style.display = "block";
            document.getElementById("puzzle-container").style.display = "block";
            game.gameOver = false;
            gameLoop();
        }

        function updateShark() {
            const distanceX = game.finley.x - game.shark.x;
            const distanceY = game.finley.y - game.shark.y;
            const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
            const speed = 1;

            game.shark.x += (distanceX / distance) * speed;
            game.shark.y += (distanceY / distance) * speed;
        }

        function updateFinley() {
            const direction = Math.random() * 2 * Math.PI;
            const speed = 2;

            game.finley.x += Math.cos(direction) * speed;
            game.finley.y += Math.sin(direction) * speed;

            if (game.finley.x < 0) game.finley.x = 0;
            if (game.finley.y < 0) game.finley.y = 0;
            if (game.finley.x > canvas.width - game.finley.width) game.finley.x = canvas.width - game.finley.width;
            if (game.finley.y > canvas.height - game.finley.height) game.finley.y = canvas.height - game.finley.height;
        }

        function checkCollisions() {
            if (game.movesRemaining <= 0 && checkCollision(game.finley, game.shark)) {
                endGame('lose');
            }
        }

        function gameLoop() {
            if (!game.gameOver) {
                updateShark();
                updateFinley();
                checkCollisions();
                renderGame();
                requestAnimationFrame(gameLoop);
            }
        }

        function renderGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = 'green';
            ctx.fillRect(game.finley.x, game.finley.y, game.finley.width, game.finley.height);

            ctx.fillStyle = 'red';
            ctx.fillRect(game.shark.x, game.shark.y, 50, 50);
        }

        function checkCollision(rect1, rect2) {
            return !(rect1.x + rect1.width < rect2.x ||
                     rect1.x > rect2.x + rect2.width ||
                     rect1.y + rect1.height < rect2.y ||
                     rect1.y > rect2.y + rect2.height);
        }
    </script>
</body>
</html>
